--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
ParasiteZed = ParasiteZed or {}
-----------------------            ---------------------------
ParasiteZed.isWIP = false
-----------------------   cell*         ---------------------------


LuaEventManager.AddEvent("OnExitBldg")
LuaEventManager.AddEvent("OnEnterBldg")
LuaEventManager.AddEvent("OnExitRoom")
LuaEventManager.AddEvent("OnEnterRoom")

local previousCell = {x = nil, y = nil}


-----------------------            ---------------------------
function ParasiteZed.isModWIP()
    if not getCore():getDebug() then return end
    return ParasiteZed.isWIP
end


function ParasiteZed.getRoom(sq)
	sq = sq or getPlayer():getCurrentSquare()
	return sq:getRoom() or nil
end
function ParasiteZed.getBldg(sq)
	sq = sq or getPlayer():getCurrentSquare()
	return sq:getBuilding() or nil
end

function ParasiteZed.addVar(nest)
	if not nest then return end
	local sq = nest:getSquare()
	if not sq then return end
	local sprName = ParasiteZed.getSprName(nest)
	if sprName and ParasiteZed.isSpawnerNest(sprName) then
		if ParasiteZed.nest ~= nil then

			ParasiteZed.doSledge(nest)
			local sprName2 = "ParasiteZedNest_" .. ZombRand(1, 6)
			local obj = IsoObject.new(getCell(), sq, sprName2)
			sq:AddTileObject(obj);
			if isClient() then
				obj:transmitCompleteItemToServer();
			end
			ISInventoryPage.renderDirty = true
		else
			ParasiteZed.nest = nest
		end
    end
end
--Events.OnObjectAdded.Add(ParasiteZed.addVar)

function ParasiteZed.reVar(nest)
	if not nest then return end
	local sq = nest:getSquare()
	if not sq then return end
	local sprName = ParasiteZed.getSprName(nest)
	if sprName and ParasiteZed.isSpawnerNest(sprName) then
		if ParasiteZed.nest == nest then
			ParasiteZed.nest = nil
		end
    end
end
--Events.OnObjectAboutToBeRemoved.Add(ParasiteZed.reVar)



function ParasiteZed.trigger()
    local pl = getPlayer()
    local csq = pl:getCurrentSquare()
    if not csq then return end
    --if not csq:isOutside() then end
    local wasIndoors = ParasiteZed.wasIndoors or false
    local isIndoors = csq:isInARoom()
    local dbg = ParasiteZed.isModWIP()
    local msg = ""
    if wasIndoors and not isIndoors then
        triggerEvent("OnExitBldg", pl, math.floor(csq:getX()), math.floor(csq:getY()), csq:getZ())
        msg = "OnExitBldg"

    end
    if not wasIndoors and isIndoors then
        triggerEvent("", pl, math.floor(csq:getX()), math.floor(csq:getY()), csq:getZ())
        msg = "OnEnterBldg"
    end

    ParasiteZed.wasIndoors = isIndoors

    local currentRoom = ParasiteZed.getRoom(sq)
    local lastRoom = ParasiteZed.lastRoom

    if currentRoom then
        if lastRoom and lastRoom ~= currentRoom then
            triggerEvent("OnExitRoom", pl, lastRoom, currentRoom)
            msg = "OnExitRoom"
        end
        if currentRoom and lastRoom ~= currentRoom then
            triggerEvent("OnEnterRoom", pl, currentRoom, lastRoom)
            msg = "OnEnterRoom"
        end
        ParasiteZed.lastRoom = currentRoom
    end

    if msg and msg ~= "" then
        ParasiteZed.plSync()
        if dbg then
            print(tostring(msg))
            pl:addLineChatElement(tostring(msg))
        end
    end
end

Events.OnPlayerMove.Remove(ParasiteZed.trigger)
Events.OnPlayerMove.Add(ParasiteZed.trigger)





-----------------------            ---------------------------
function ParasiteZed.init(playerIndex, pl)
    if not pl then return end
    local md = pl:getModData()
    if md then
        md.ParasiteZed_KillCount = md.ParasiteZed_KillCount or 0
    end
end
Events.OnCreatePlayer.Remove(ParasiteZed.init)
Events.OnCreatePlayer.Add(ParasiteZed.init)


-----------------------            ---------------------------

function ParasiteZed.getPointer()
    local pl = getPlayer()
    if not pl then return nil end
    local zPos = pl:getZ()
    local xx, yy = ISCoordConversion.ToWorld(getMouseXScaled(), getMouseYScaled(), zPos)
    local sq = getCell():getGridSquare(math.floor(xx), math.floor(yy), zPos)
    return sq
end


function ParasiteZed.isWearingParasiteMask(pl)
    if not pl then return false end
    local wornItems = pl:getWornItems()
    if not wornItems then return false end

    for i = 0, wornItems:size() - 1 do
        local item = wornItems:get(i):getItem()
        if item and item:getFullType() == "Base.ParasiteZed_Mask" then
            return true
        end
    end

    return false
end





--[[
local csq = pl:getCurrentSquare()
if csq and sq and csq == sq then
    local md = pl:getModData()['']
    if md then
        pl:addLineChatElement(tostring(md.ParasiteZed_KillCount))
    end
end
 ]]

 -----------------------            ---------------------------

--LuaEventManager.AddEvent("OnCellChange")

--[[

function ParasiteZed.getCellEdgeSquares(startX, startY)
    local edgeSquares = {}

    for x = startX, startX + 299 do
        table.insert(edgeSquares, {x = x, y = startY})
    end


    for x = startX, startX + 299 do
        table.insert(edgeSquares, {x = x, y = startY + 299})
    end


    for y = startY + 1, startY + 298 do
        table.insert(edgeSquares, {x = startX, y = y})
    end


    for y = startY + 1, startY + 298 do
        table.insert(edgeSquares, {x = startX + 299, y = y})
    end

    return edgeSquares
end
 ]]
--[[
function ParasiteZed.setMarkersToCellEdge(enable)
    local pl = getPlayer()
    local x, y, z = round(pl:getX()), round(pl:getY()), round(pl:getZ())
    local startX, startY = math.floor(x / 300) * 300, math.floor(y / 300) * 300
    edgeMarkers = edgeMarkers or {}
    if not enable then
        for _, marker in ipairs(edgeMarkers) do
            if marker then
                marker:remove()
            end
        end
        edgeMarkers = {}
        return
    end

    local edgeSquares = ParasiteZed.getCellEdgeSquares(startX, startY)
    for _, eSq in ipairs(edgeSquares) do
        local sq = getCell():getOrCreateGridSquare(eSq.x, eSq.y, z)
        if sq then
            local marker = getWorldMarkers():addGridSquareMarker("circle_center", "circle_only_highlight", sq, 1, 1, 1, true, 1)
            table.insert(edgeMarkers, marker)
        end
    end
end

 ]]
 --[[
function ParasiteZed.OnCellChangeEvent(pl)
    local currentCellX, currentCellY = math.floor(pl:getX() / 300), math.floor(pl:getY() / 300)
    if previousCell.x ~= currentCellX or previousCell.y ~= currentCellY then
        triggerEvent("OnCellChange", previousCell.x,  previousCell.y, currentCellX, currentCellY)
        previousCell.x, previousCell.y = currentCellX, currentCellY
    end
end
--Events.OnPlayerMove.Add(ParasiteZed.OnCellChangeEvent)

function ParasiteZed.OnCellChange(prevX, prevY, curX, curY)
    local msg = ""
    ParasiteZed.plSync()
    if ParasiteZed.isWIP then
        msg = "OnCellChaned:\nPrevious Cell\nX: "..tostring(prevX) .."Y: ".. tostring(prevY).."\n".. "Current Cell\nX: "..tostring(curX) .."Y: ".. tostring(curY)

        ParasiteZed.setMarkersToCellEdge(false)
        ParasiteZed.setMarkersToCellEdge(true)
        timer:Simple(10, function() ParasiteZed.setMarkersToCellEdge(false) end)
    end
    if msg and msg ~= "" then
        print(tostring(msg))
        getPlayer():addLineChatElement(tostring(msg))
    end
end
Events.OnCellChange.Remove(ParasiteZed.OnCellChange)
 ]]
--Events.OnCellChange.Add(ParasiteZed.OnCellChange)