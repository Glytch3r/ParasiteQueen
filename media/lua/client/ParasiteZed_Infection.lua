--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
ParasiteZed = ParasiteZed or {}
function ParasiteZed.getRemainingTime(pl)
    pl = pl or getPlayer()
    if not pl then return nil end
    local data = pl:getModData()
    return data and data.ParasiteInfectionTime or nil
end

function ParasiteZed.doParasiteInfect(pl)
    pl = pl or getPlayer()
    if not pl then return end
    local data = pl:getModData()
    local duration = SandboxVars.ParasiteQueen.ParasiteInfection or 1440

    if not ParasiteZed.isParasiteInfected(pl) then
        data.ParasiteInfectionTime = duration
    end

    if getCore():getDebug() and isAdmin() then
        print("Infected:", ParasiteZed.getRemainingTime(pl))
    end
end

function ParasiteZed.doDeathByInfection(pl)
    pl = pl or getPlayer()
    if not pl then return end

    local bd = pl:getBodyDamage()
    if bd then
        bd:setInfected(true)
        bd:setInfectionTime(0.1)
        if not pl:isGodMod() then
            pl:Kill(nil)
            local sq = pl:getCurrentSquare()
            if sq and (SandboxVars.ParasiteQueen.DeathSpawn ~= false) then
                timer:Simple(3, function()
                    ParasiteZed.doSpawn(sq, false, "ParasiteZed")
                end)
            end
        end
    end
end

function ParasiteZed.min()
    local pl = getPlayer()
    if not pl then return end

    local data = pl:getModData()
    local time = data.ParasiteInfectionTime
    if not time then return end

    if time > 0 then
        data.ParasiteInfectionTime = time - 1
    elseif time <= 0 then
        data.ParasiteInfectionTime = nil
        ParasiteZed.doDeathByInfection(pl)
    end

end
Events.EveryOneMinute.Remove(ParasiteZed.min)
Events.EveryOneMinute.Add(ParasiteZed.min)


function ParasiteZed.isParasiteInfected(pl)
    pl = pl or getPlayer()
    return pl:getModData().ParasiteInfectionTime ~= nil
end

function ParasiteZed.hit(zpl, pl, wpn, HP)
    if not instanceof(zpl, "IsoPlayer") or not instanceof(pl, "IsoPlayer") then return end
    if SandboxVars.ParasiteQueen.PlayerInfectPlayer ~= false and (ParasiteZed.isParasitePl(zpl) or ParasiteZed.isParasiteQueenPl(zpl)) then
        local chance = SandboxVars.ParasiteQueen.InfectionChance or 100
        if ParasiteZed.doRoll(chance) then
            ParasiteZed.doParasiteInfect(pl)
        end
    end
    ParasiteZed.plSync()
end
Events.OnWeaponHitCharacter.Remove(ParasiteZed.hit)
Events.OnWeaponHitCharacter.Add(ParasiteZed.hit)


function ParasiteZed.plDmg(pl, dType, dmg)
    local zed = pl:getAttackedBy()
    if zed then
        if ParasiteZed.isParasiteZed(zed) then
           
        local chance = SandboxVars.ParasiteQueen.InfectionChance or 100
        if ParasiteZed.doRoll(chance) then
            ParasiteZed.doParasiteInfect(pl)
        end
        pl:setAttackedBy(nil)
        elseif ParasiteZed.isParasiteQueen(zed) then
            
            --pl:Kill(pl)
        end
    end
end
Events.OnPlayerGetDamage.Remove(ParasiteZed.plDmg)
Events.OnPlayerGetDamage.Add(ParasiteZed.plDmg)

-----------------------  cure*  immune* pill* pills*   ---------------------------

function ParasiteZed.hookPill()
    local hook = ISTakePillAction.perform
    function ISTakePillAction:perform()
        local itemType = self.item and self.item:getFullType()
        if itemType == "Base.ParasiteZed_AntiParasitic" then
            local duration = SandboxVars.ParasiteQueen.ParasiteImmunity or 5
            local modData = self.character:getModData()
            modData.ParasiteImmuneTime = (modData.ParasiteImmuneTime or 0) + duration

            if getCore():getDebug() then
                print("AntiParasitic Hours Remaining: " .. tostring(modData.ParasiteImmuneTime))
            end
        end
        return hook(self)
    end
end

Events.OnCreatePlayer.Remove(ParasiteZed.hookPill)
Events.OnCreatePlayer.Add(ParasiteZed.hookPill)


function ParasiteZed.immunity()
    local pl = getPlayer()
    if not pl then return end

    local data = pl:getModData()
    local time = data.ParasiteImmuneTime
    if not time then return end

    if time > 0 then
        data.ParasiteImmuneTime = time - 1
    end
    if time <= 0 then
        data.ParasiteImmuneTime = nil
    end

end
Events.EveryHours.Remove(ParasiteZed.immunity)
Events.EveryHours.Add(ParasiteZed.immunity)

-----------------------            ---------------------------

ParasiteZed.lastMouseCheck = 0
function ParasiteZed.mousePoint()
    if not isIngameState() then return end

    local pl = getPlayer()
    if not pl or not ParasiteZed.isWearingParasiteMask(pl) then return end

    local now = getTimestampMs()
    if now - ParasiteZed.lastMouseCheck < 4500 then return end
    ParasiteZed.lastMouseCheck = now

    local sq = ParasiteZed.getPointer()
    if not sq then return end

    for i = 0, sq:getMovingObjects():size() - 1 do
        local chr = sq:getMovingObjects():get(i)
        if chr then
            if instanceof(chr, "IsoZombie") then
                chr:addLineChatElement("Health: " .. tostring(chr:getHealth()))
            elseif  instanceof(chr, "IsoPlayer") then
                local md = chr:getModData()
                if md then
                    local score = md.ParasiteZed_KillCount or 0
                    chr:addLineChatElement("Parasite Killed: " .. tostring(score))
                    if (getCore():getDebug() and  ParasiteZed.isAdm(pl)) and ParasiteZed.isWIP then
                      --  pl:setHaloNote( "NestCell: ".. tostring(ParasiteZed.getNestCellName()),150,250,150,900)
                    end
                end
            end
        end
    end
end
Events.OnTick.Add(ParasiteZed.mousePoint)
