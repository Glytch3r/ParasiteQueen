--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



ParasiteZed = ParasiteZed or {}

function ParasiteZed.isCrawler(zed)
	return zed:isCrawling()
end


function ParasiteZed.setCrawler(zed)

	zed:setCrawler(true);
	zed:setCanCrawlUnderVehicle(true)
	zed:setCanWalk(false);

end






--[[
function ParasiteZed.setCrawler(zed)
    if not zed:isCrawling() then
		zed:toggleCrawling()
		if not zed:isCrawling() then
			--zed:setFallOnFront(true)
			zed:knockDown(true)
		end
		zed:setCanWalk(false)
		if not zed:isCrawling() then
			zed:setVariable('bbecomecrawler', 'true')
		end
		zed:setCanCrawlUnderVehicle(true)
    end
	zed:setCrawlerType(1)
end
 ]]
--[[ 
function ParasiteZed.setCrawler(zed)
	zed:setCanWalk(false);
	zed:setOnFloor(true);
	zed:knockDown(true)
	zed:toggleCrawling()
	zed:setKnockedDown(true);
	zed:setCrawler(true);
	zed:setCanWalk(false);
	zed:setCanCrawlUnderVehicle(true)
	zed:setBecomeCrawler(true);
	zed:setVariable('bbecomecrawler', 'true')
	--zed:addLineChatElement(tostring(zed:getCrawlerType()))
	if not zed:isCrawling() then
		zed:toggleCrawling()
	end
end

 ]]

-----------------

function ParasiteZed.isWalkable(sq)
    if not sq then return false end
    if sq:isSolid() then return false end
    if sq:isSolidTrans() then return false end
    if sq:Is(IsoFlagType.water) then return false end
    --if not square:isNotBlocked(false) then return false end
    return true
end

function ParasiteZed.stopWalking(targ)
	targ:getPathFindBehavior2():reset();
end



function ParasiteZed.isStepped(zed)
	return zed:isBeingSteppedOn()
end





function ParasiteZed.isShouldStand(zed)
	if not zed:isBeingSteppedOn() then
		if zed:isCanWalk() then return true end
		if zed:isFakeDead() then return true end
		if zed:isForceEatingAnimation() then return true end
		if zed:isOnFloor() then return true end
		if zed:isCrawling() then return true end
		if zed:isUseless() then return true end
		if zed:isSitAgainstWall() then return true end
	end
    return false
end

function ParasiteZed.setStand(zed)
    if not zed:isCanWalk() then
        zed:setCanWalk(true)
    end
    if zed:isFakeDead() or zed:isCurrentState(FakeDeadZombieState.instance())  then
        zed:setFakeDead(false)
		zed:setForceFakeDead(false);
    end
    if zed:isForceEatingAnimation() then
        zed:setForceEatingAnimation(false)
    end
    if zed:isSitAgainstWall() then
        zed:setSitAgainstWall(false)
    end
    if zed:isCrawling() then
        zed:toggleCrawling()
		zed:setCrawler(false)
    end
	if zed:isOnFloor() then
		zed:knockDown(false)
		zed:changeState(ZombieGetUpState.instance())
	end
	if zed:isUseless() then
		zed:setUseless(false)
	end
	zed:setOnFloor(false);
end

function ParasiteZed.getWalkType(zed)
	return tostring(zed:getVariableString("zombieWalkType"))
end

function ParasiteZed.getWalkNum(zed)
	local walk = ParasiteZed.getWalkType(zed)
	return tonumber(walk:match("%d+"))
end

function ParasiteZed.isSprinter(zed)
	local walk = ParasiteZed.getWalkType(zed)
	if walk then
		if tostring(walk:contains('sprint')) or luautils.stringStarts(walk, "sprint") then
			return true
		end
	end
	return false
end

function ParasiteZed.isMoving(zed)
	if not zed then return false end
	--if not ParasiteZed.isParasiteZed(zed) then return false end
	return zed:getVariableBoolean('bMoving')
end

function ParasiteZed.turnAround(targ)
	local x = targ:getX()
	local y = targ:getY()
	local offsetX = targ:getForwardDirection():getX() * 2
	local offsetY = targ:getForwardDirection():getY() * 2
	targ:faceLocation(x - offsetX, y - offsetY)
end

function ParasiteZed.checkWalkableSq()
	local pl = getPlayer()
	local plSq = pl:getSquare()
	local rmSqs = plSq:getRoom():getSquares()
	if not pl:isOutside() then
		for i=0, rmSqs:size()-1 do
			local rmSq = rmSqs:get(i)
			local tab = {
				rmSq:getN(),
				rmSq:getS(),
				rmSq:getE(),
				rmSq:getW(),
			}
			for _, testSq in ipairs(tab) do
				if testSq  then
					local isGood = false
					if ParasiteZed.isWalkable(testSq) then
						isGood = true
					end
					ParasiteZed.TempMarker(testSq, isGood)
				end
			end
		end
	end
end

function ParasiteZed.moveToXYZ(zed, x, y, z)
    if not zed then return end
    local sq = getCell():getGridSquare(x, y, z)
    if not sq or not sq:isFree(false) or not sq:isSolidFloor() then return end

    local pf = zed:getPathFindBehavior2()
    if pf and not pf:isTarget(x, y, z) then
        pf:pathToLocation(x, y, z)
        zed:setVariable("bPathfind", true)
        zed:setVariable("bMoving", true)
    end
end


function ParasiteZed.seekAndPlantNest(zed)
    if not zed or zed:isDead() then return end
    local cell = getCell()
    local closest, dist = nil, 9999
    local x, y, z = zed:getX(), zed:getY(), zed:getZ()

    for i = 0, cell:getObjectList():size() - 1 do
        local obj = cell:getObjectList():get(i)
        if instanceof(obj, "IsoDeadBody") and not obj:isRemoved() then
            local sq = obj:getSquare()
            if sq and not ParasiteZed.getNest(sq) then
                local d = obj:DistTo(x, y)
                if d < dist then
                    dist = d
                    closest = obj
                end
            end
        end
    end

    if closest then
        zed:getPathFindBehavior2():pathToLocation(closest:getX(), closest:getY(), closest:getZ())
        Events.OnPlayerUpdate.Add(function()
            if not zed or zed:isDead() then Events.OnPlayerUpdate.Remove(this) return end
            if zed:getSquare() == closest:getSquare() then
                ParasiteZed.plantNestOnCorpseSquare(zed, closest:getSquare())
                Events.OnPlayerUpdate.Remove(this)
            end
        end)
    end
end

function ParasiteZed.plantNestOnCorpseSquare(zed, sq)
    if not sq or ParasiteZed.getNest(sq) then return end
    ParasiteZed.doSpawnQueenNest(sq)
    ParasiteZed.doSpawn(sq, false, "ParasiteZed")
    ParasiteZed.seekAndPlantNest(zed)
end

function ParasiteZed.seek(zed)
    if not zed or zed:isDead() then return end
    local cell = getCell()
    local closest, dist = nil, 9999
    local x, y, z = zed:getX(), zed:getY(), zed:getZ()
    for i = 0, cell:getObjectList():size() - 1 do
        local obj = cell:getObjectList():get(i)
        if instanceof(obj, "IsoDeadBody") and not obj:isRemoved() then
            local d = obj:DistTo(x, y)
            if d < dist then
                dist = d
                closest = obj
            end
        end
    end
    if closest then
		local targSq = getCell():getOrCreateGridSquare(closest:getX(), closest:getY(), closest:getZ()) 
		if not ParasiteZed.getNest(targSq) then
			zed:getPathFindBehavior2():pathToLocation(closest:getX(), closest:getY(), closest:getZ())
		end
    end
end
function ParasiteZed.huntCorpse(zed)
    if not zed or zed:isDead() then return end
    local cell = getCell()
    local zx, zy, zz = zed:getX(), zed:getY(), zed:getZ()
    local closest, bestDist = nil, 9999

    for i = 0, cell:getObjectList():size() - 1 do
        local obj = cell:getObjectList():get(i)
        if instanceof(obj, "IsoDeadBody") and not obj:isRemoved() then
            local sq = obj:getSquare()
            if sq and sq:getZ() == zz then
                local d = obj:DistTo(zx, zy)
                if d < bestDist then
                    bestDist = d
                    closest = obj
                end
            end
        end
    end

    if closest then
        local sq = closest:getSquare()
        if sq and sq:isFree(false) and sq:isSolidFloor() then
            local pf = zed:getPathFindBehavior2()
            if pf and not pf:isTarget(sq:getX(), sq:getY(), sq:getZ()) then
                pf:pathToLocation(sq:getX(), sq:getY(), sq:getZ())
                zed:setVariable("bPathfind", true)
                zed:setVariable("bMoving", true)
            end
        end
    end
end

--[[ 

if not ParasiteZed.getNest(sq) then
	ParasiteZed.doSpawnQueenNest(sq)
	ParasiteZed.doSpawn(sq, false, "ParasiteZed")	
	ParasiteZed.seek(zed)
end
 ]]