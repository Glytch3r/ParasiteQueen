--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

--3458740967 original workshop id

ParasiteZed = ParasiteZed or {}

local Commands = {}
Commands.ParasiteZed = {}

local ticks = 0
--[[ 
function ParasiteZed.syncModdata()
    ticks = ticks + 1
    if ticks % 250 == 0 then
        local pl = getPlayer()
        if not pl then return end

        local killCount = pl:getModData()["ParasiteZed_KillCount"]
        local QueenKillCount = pl:getModData()["QueenKillCount"]
        if isClient() and killCount ~= nil then
            sendClientCommand('ParasiteZed', 'syncKills', { killCount = killCount, QueenKillCount = QueenKillCount, id = pl:getOnlineID() })
        end
    end
    if ticks >= 500 then
        ticks = 0
    end
end
Events.OnPlayerUpdate.Add(ParasiteZed.syncModdata)
 ]]

function ParasiteZed.doSyncPlayerData(pl)
    pl = pl or getPlayer()
    if not pl then return end

    local modData = pl.getModData and pl:getModData() or nil
    if not modData or type(modData) ~= "table" then return end

    local data = {
        isParasiteQueenPl = (modData["isParasiteQueenPl"] ~= nil) and modData["isParasiteQueenPl"] or false,
        isParasitePl = (modData["isParasitePl"] ~= nil) and modData["isParasitePl"] or false,
        QueenKillCount = (modData["ParasiteZed_QueenKillCount"] ~= nil) and modData["ParasiteZed_QueenKillCount"] or 0,
        KillCount = (modData["ParasiteZed_KillCount"] ~= nil) and modData["ParasiteZed_KillCount"] or 0,
    }

    if isClient() then
        sendClientCommand('ParasiteZed', 'syncPlayer', { data = data, id = pl.getOnlineID and pl:getOnlineID() or -1 })
    end
end

Events.OnScoreboardUpdate.Add(ParasiteZed.doSyncPlayerData)

Commands.ParasiteZed.syncPlayer = function(args)
    local pl = getPlayer() 
    if not args or not args.id then return end
    local targ = getPlayerByOnlineID(args.id)
    if not targ then return end
    local data = args.data
    if not data then return end
    if pl and pl ~= targ then
        local md = targ:getModData()
        if not md then return end
        md["isParasitePl"] = data.isParasitePl  or false
        md["isParasiteQueenPl"] = data.isParasiteQueenPl  or false
        md["ParasiteZed_KillCount"] = data.KillCount  or 0
        md["ParasiteZed_QueenKillCount"] = data.QueenKillCount  or 0
        targ:setVariable('isParasiteZed', md["isParasitePl"]);
        targ:setVariable('isParasiteQueenPl', md["isParasiteQueenPl"]);    
   end
end

-----------------------            ---------------------------




function ParasiteZed.doSyncData(zed)
    if not isClient() then return end
    if not zed or zed:isDead() then return end
    local pl = getPlayer()
    if not pl then return end
    if getOnlinePlayers():size() <= 1 then return end
    if ParasiteZed.isClosestPl(pl, zed) then
        local modData = zed:getModData()
        if not modData then return end
        local data = {
            ParasiteZed_Gas  = modData["ParasiteZed_Gas"]  or nil,
            ParasiteZed_Spit = modData["ParasiteZed_Spit"] or nil,
            ParasiteZed_Egg  = modData["ParasiteZed_Egg"]  or nil,
            ParasiteZed_Scent  = modData["ParasiteZed_Scent"]  or nil,
        }
        
        sendClientCommand('ParasiteZed', 'data', { data = data, zedID = zed:getOnlineID(), useless = zed:isUseless()})
    end
end

Commands.ParasiteZed.data = function(args)
    local pl = getPlayer()
    local sender = getPlayerByOnlineID(args.id)
    if sender and pl and pl ~= sender then
        local zedID = args.zedID
        local data = args.data
        if not data then return end
        if type(zedID) == 'string' then zedID = tonumber(zedID) end
        local zed = ParasiteZed.findzedID(zedID)
        if zed then
            local md = zed:getModData()
            md["ParasiteZed_Gas"]  = data.ParasiteZed_Gas  or nil
            md["ParasiteZed_Spit"] = data.ParasiteZed_Spit or nil
            md["ParasiteZed_Egg"]  = data.ParasiteZed_Egg  or nil
            md["ParasiteZed_Scent"]  = data.ParasiteZed_Scent  or nil

            if args.useless ~= nil then 
                zed:setUseless(args.useless)
            end
        end
    end
end



-----------------------            ---------------------------

Commands.ParasiteZed.OnDoGas = function(args)
    if not args or not args.id then return end
--[[     local targ = getPlayerByOnlineID(args.id)
    if not targ then return end ]]
    local x = args.x
    local y = args.y
    local z = args.z
    if x and y and z then
        local sq = getCell():getOrCreateGridSquare(x, y, z) 
        local zedID = args.zedID
        if type(zedID) == 'string' then zedID = tonumber(zedID) end
        local zed = ParasiteZed.findzedID(zedID)
        if zed ~= nil then
            if sq then
                ParasiteZed.doGas(zed, sq)
            end
        end
    end
end


Commands.ParasiteZed.OnSpitHit = function(args)
    if not args or not args.id then return end
    local targ = getPlayerByOnlineID(args.id)
    if not targ then return end
    local car = targ:getVehicle() 
    if car then
        car:addRandomDamageFromCrash(targ, 15)
        car:engineDoStalling()
    else
        targ:setBumpType("pushedbehind"); 
        targ:setVariable("BumpFall", true);
        targ:setVariable("BumpFallType", "pushedbehind"); 
    end
    ParasiteZed.setScent(targ)
end

-----------------------            ---------------------------
function ParasiteZed.isShouldChase(zed)
    local targ = zed:getTarget()
    if not targ then return false end
    if zed:getModData()['ParasiteZed_Scent'] ~= nil then return true end
    local minDist = SandboxVars.ParasiteQueen.DistToChase or 6
    local minSeenTime = SandboxVars.ParasiteQueen.SeenTime or 4

    return ParasiteZed.checkDist(zed, targ) >= minDist
        and zed:getTargetSeenTime() >= minSeenTime
end

function ParasiteZed.setScent(targ)
  
    if not targ then return end
    targ:getModData()['ParasiteZed_Scent'] = true
    ParasiteZed.doSyncData(zed)

    timer:Simple(10, function()  
        if targ and targ:isAlive() then
            targ:getModData()['ParasiteZed_Scent'] = nil 
            ParasiteZed.doSyncData(zed)
        end
    end)
end


function ParasiteZed.isShouldObserve(zed)
    local targ = zed:getTarget()
    if not targ then return false end
    if zed:getModData()['ParasiteZed_Scent'] ~= nil then return false end
    local minDist = SandboxVars.ParasiteQueen.DistToChase or 6
    local minSeenTime = SandboxVars.ParasiteQueen.SeenTime or 4
    local seen =  zed:getTargetSeenTime() * 100
    return ParasiteZed.checkDist(zed, targ) <= minDist and seen <= minSeenTime

end

function ParasiteZed.soldier(zed)
    if not zed then return end

    if ParasiteZed.isParasiteZed(zed) then
        if zed:getModData()['ParasiteZed_Init'] == nil then
            ParasiteZed.cleanUp(zed)

            ParasiteZed.setStats(zed)
        end

        if not zed:getVariableBoolean('isParasiteZed') then
            zed:setVariable('isParasiteZed', true)
        end
        
        if not ParasiteZed.isCrawler(zed) then
            ParasiteZed.setCrawler(zed)
        end
        local targ = zed:getTarget()
        local isShouldObserve = ParasiteZed.isShouldObserve(zed)
        if isShouldObserve and targ then
            if not zed:isUseless() then
                zed:setUseless(true)
            end
            if targ then
                zed:faceLocation(targ:getX(), targ:getY())

                local showAlert = SandboxVars.ParasiteQueen.AlertIndicator or true
                if showAlert and showAlert ~= "" then
                    if getCore():getDebug() and isAdmin() then
                        showAlert = showAlert .. " " .. tostring(zed:getTargetSeenTime() * 100)
                    end
                    zed:addLineChatElement(tostring(showAlert))
                end
            end
        else
            if zed:isUseless() then
                zed:setUseless(false)
            end
        end
    else
        if zed:getVariableBoolean('isParasiteZed') then
            zed:setVariable('isParasiteZed', false)
            zed:getModData()['ParasiteZed_Init'] = nil
        end
    end
end

Events.OnZombieUpdate.Remove(ParasiteZed.soldier)
Events.OnZombieUpdate.Add(ParasiteZed.soldier)


-----------------------            ---------------------------


Commands.ParasiteZed.KnockDown = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    local zedID = args.zedID
    if type(zedID) == 'string' then zedID = tonumber(zedID) end
    local zed = ParasiteZed.findzedID(zedID)
	if source ~= player then
		if zed ~= nil then
			zed:setKnockedDown(true)
		end
	end
end
--[[ 

Commands.ParasiteZed.CellEvent = function(args)
    local cellName = args.cellName
    if cellName then

        local pl = getPlayer()
        local x, y = round(pl:getX()),  round(pl:getY())

		local curCellName = ParasiteZed.getNestCellName(x, y)
		if curCellName and curCellName == cellName then
            x = ParasiteZed.getCurrentNestCellX(pl)
            y = ParasiteZed.getCurrentNestCellY(pl)
            triggerEvent("OnNestCellChange", x, y, x,  y)
        end

    end
end
 ]]
-----------------------            ---------------------------

Commands.ParasiteZed.isParasiteZed = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    local zedID = args.zedID
    if type(zedID) == 'string' then zedID = tonumber(zedID) end
    local zed = ParasiteZed.findzedID(zedID)
    if zed ~= nil then
		if source ~= player then
			if args.isParasiteZed == 'true' then
				zed:setVariable('isParasiteZed', 'true');
			else
				zed:setVariable('isParasiteZed', 'false');
			end
		end
    end
end
-----------------------            ---------------------------
    

Commands.ParasiteZed.isParasiteQueenPl = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    if player ~= nil then
        if source ~= player then
            if args.isParasitePl then
                --ParasiteZed.wearParasiteZed(player)
                --player:setHideWeaponModel(true)
                player:setVariable('isParasiteQueenPl', "true");        
            else
                --ParasiteZed.clearParasiteZedSkin(player)
                --player:setHideWeaponModel(false)
                player:setVariable('isParasiteQueenPl', "false");
            end
        end
    end
    --player:resetModelNextFrame();
end
Commands.ParasiteZed.isParasitePl = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    if player ~= nil then
        if source ~= player then
            if args.isParasitePl then
                --ParasiteZed.wearParasiteZed(player)
                --player:setHideWeaponModel(true)
                player:setVariable('isParasitePl', "true");
            else
                --ParasiteZed.clearParasiteZedSkin(player)
                --player:setHideWeaponModel(false)
                player:setVariable('isParasitePl', "false");
            end
        end
    end
    --player:resetModelNextFrame();
end

--[[ Commands.ParasiteZed.Injury = function(args)
    local source = getPlayer();
   --local player = getPlayerByOnlineID(args.id)
	local targ = getPlayerByOnlineID(args.targID)
    if source ~= targ then
		ParasiteZed.doInjury(targ)
    end
end

 ]]


Events.OnServerCommand.Add(function(module, command, args)
	if Commands[module] and Commands[module][command] then
		Commands[module][command](args)
	end
end)
