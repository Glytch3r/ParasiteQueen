--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       		 Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							  |
|                       		 Discord:    Glytch3r#1337 / glytch3r															  |
|                       		 Support:    https://ko-fi.com/glytch3r														 	  |
|_________________________________________________________________________________________________________________________________|
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████-]]

----------------------------------------------------------------------------------------------------------------------------------


ParasiteZed = ParasiteZed or {}

function ParasiteZed.getRewards()
    if not sq then return end
    if ParasiteZed.parsedItems == nil then
        ParasiteZed.parsedItems = ParasiteZed.parseItems()
    end
    local randomItem = nil
    local itemList = ParasiteZed.parsedItems
    if #itemList == 0 then return end

    if ParasiteZed.getRewardRoll() then
        randomItem = itemList[ZombRand(1, #itemList + 1)]
        if randomItem then
            if getCore():getDebug() then
                print("Spawned: "..tostring(randomItem))
            end
        end
    end
    return randomItem
end



function ParasiteZed.getRewardRoll()
    local chance = SandboxVars.ParasiteZed_Queen.DropRate or 20
    if chance <= 0 then return false end
    if chance >= 100 then return true end
    return ParasiteZed.doRoll(chance)
end

function ParasiteZed.getDeathRewards()
    return SandboxVars.ParasiteZed_Queen.DeathRewards or 'Base.Katana;Base.Machete'
end

function ParasiteZed.parseItems()
    local tab = {}
    local lootStr = ParasiteZed.getDeathRewards()
    if lootStr and lootStr ~= '' then
        for item in string.gmatch(lootStr, "([^;]+)") do
            table.insert(tab, item)
        end
    end
    return tab
end

ParasiteZed.materialDropTable = {
    [1] = "Base.ParasiteZed_Exosac",
    [2] = "Base.ParasiteZed_Raptorial",
    [3] = "Base.ParasiteZed_HeadCapsule",
    [4] = "Base.ParasiteZed_HindLimb",
    [5] = "Base.ParasiteZed_DorsalVessel",
    [6] = "Base.ParasiteZed_Mandibles",
    [7] = "Base.ParasiteZed_Aculeus",
    [8] = "Base.ParasiteZed_Metasoma",
}

function ParasiteZed.getMaterialDrop()
    if not ParasiteZed.doRoll(10) then return nil end
    local roll = ZombRand(1, 9)
    local mat = ParasiteZed.materialDropTable[roll]

    if getCore():getDebug() then
        getPlayer():addLineChatElement("Rolled: [" .. tostring(roll) .. "] " .. tostring(mat or "None"))
    end

    return mat
end
--[[
function ParasiteZed.doDropMaterial(sq)
    sq = sq or  getPlayer():getSquare()
    if not sq then return end
    local roll = ZombRand(1, 9)
    local mat = ParasiteZed.getMaterialDrop()
    if mat then
        sq:AddWorldInventoryItem(mat, 0, 0, 0)
        ISInventoryPage.dirtyUI()
    end
end
 ]]
ParasiteZed.LearnTable = {
    ["Craft Parasite Armor"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftDummy or 100,
    ["Craft Parasite Spear"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftSword or 85,
    ["Craft Parasite Sword"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftArmor or 70,
    ["Preserved Parasite Egg"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftSpear or 60,
    ["Craft Parasite Head Trophy"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftEgg or 50,
    ["Craft Parasite Mask"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftMask or 40,
    ["Construct Parasite Dummy"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftTrophy or 30,
    ["Paint Parasite Anatomy"] = SandboxVars.ParasiteZed_Queen.KillsToLearnCraftAnatomy or 20,
    ["Synthesize Anti Parasitic Medication"] = SandboxVars.ParasiteZed_Queen.KillsToLearnAntiParasitic or 200,
    ["Craft Pesticide Bomb"] = SandboxVars.ParasiteZed_Queen.KillsToLearnBugBomb or 110,
}

function ParasiteZed.RewardsHandler(zed)
    local pl = getPlayer()
    local sq = zed:getSquare()
    if not pl or not sq then return end
    if not ParasiteZed.isParasiteZed(zed)  then return end
    local attacker = zed:getAttackedBy()
    local inv = zed:getInventory();

    if not attacker then return end
    if ParasiteZed.isClosestPl(pl, zed) or (attacker and attacker == pl) then
        local mats = ParasiteZed.getMaterialDrop()
        local loot =  ParasiteZed.getRewards()
        if loot then
            inv:AddItem(loot)
        end
        if mats then
            inv:AddItem(mats)
        end
    end


    local md = attacker:getModData()
    if not md then return end

    md.ParasiteZed_KillCount = (md.ParasiteZed_KillCount or 0) + 1
    local score = md.ParasiteZed_KillCount

    if attacker == pl then
        for recipeStr, killReq in pairs(ParasiteZed.LearnTable) do
            if score >= killReq and not pl:isRecipeKnown(recipeStr) then
                ParasiteZed.LearnHandler(recipeStr, pl)
            end
        end

        if getCore():getDebug() then
            zed:addLineChatElement("Parasite kill count: " .. tostring(score))
            local user = attacker:getUsername()
            if user then
                zed:addLineChatElement("Attacker: " .. tostring(user))
            end
            print("KillCount: " .. tostring(score))
        end
    end
end

Events.OnZombieDead.Add(ParasiteZed.RewardsHandler)

function ParasiteZed.LearnHandler(recipeStr, pl)
    pl = pl or getPlayer()
    pl:getKnownRecipes():add(recipeStr)
    getSoundManager():playUISound("GainExperienceLevel")
    pl:addLineChatElement("Learned: " .. recipeStr)
end
