--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
ParasiteZed = ParasiteZed or {}

Events.OnCreatePlayer.Add(function()
    ParasiteZed.col = ColorInfo.new(0.38, 0.86, 0.78, 1);
    ParasiteZed.marker = nil
    ParasiteZed.guide = nil
    ParasiteZed.bomb = nil
    ParasiteZed.color = { r = 1, g = 1, b = 1, a = 1 }
    ParasiteZed.MinDist = 5
end)
-----------------------            ---------------------------
function ParasiteZed.tempMark(sq)
    if not sq then return end
    ParasiteZed.addMark(sq)
    timer:Simple(30, function()
        ParasiteZed.delMark()
    end)
end
function ParasiteZed.getRandCol()
    return ZombRand(0, 101) /100
end



function ParasiteZed.moveMark(sq)
    sq = sq or  getPlayer():getSquare()
    if ParasiteZed.marker ~= nil then
        local x, y, z = round(sq:getX()),  round(sq:getY()),  sq:getZ()
        ParasiteZed.marker:setPos(x, y, z)
    end
end
function ParasiteZed.setMarkSize(size)
    size = size or 1
    if ParasiteZed.marker ~= nil then
        ParasiteZed.marker:setSize(size)
    end
end

function ParasiteZed.getMarkSize()
    if ParasiteZed.marker then
        return ParasiteZed.marker:getSize()
    end
    return nil
end
-----------------------            ---------------------------
function ParasiteZed.addMark(sq)
    local pl = getPlayer()
    sq = sq or pl:getSquare();
    if ParasiteZed.marker ~= nil then
        ParasiteZed.delMark()
    end
    if sq then
        if ParasiteZed.marker == nil then
            ParasiteZed.randCol = { r = ParasiteZed.getRandCol(), g = ParasiteZed.getRandCol(), b = ParasiteZed.getRandCol(), a = 1 }
            ParasiteZed.marker = getWorldMarkers():addGridSquareMarker("ParasiteZedNest_Marker", "ParasiteZedNest_Marker",  sq, ParasiteZed.randCol.r, ParasiteZed.randCol.g, ParasiteZed.randCol.b,  true,  ZombRand(2,4))
            --ParasiteZed.marker = getWorldMarkers():addPlayerHomingPoint(pl, sq:getX(), sq:getY(), "ParasiteZed", ParasiteZed.color.r, ParasiteZed.color.g, ParasiteZed.color.b, ParasiteZed.color.a, true, 60);
        end
    end
end
function ParasiteZed.doGasTrigger(zed)
    local sq = zed:getSquare() 
    local pl = getPlayer()
    getSoundManager():PlayWorldSound("ParasiteZed_SpitHit", sq, 0, 5, 5, false)    

    if isClient() then
        local x, y, z = round(sq:getX()),  round(sq:getY()),  sq:getZ() or 0
        sendClientCommand('ParasiteZed', 'doGas', {id = pl:getOnlineID(), x = x, y = y, z = z, zedID = zed:getOnlineID()})
    end
end
function ParasiteZed.doGas(zed, sq)
    local rad = 0.1
    sq = sq or zed:getSquare()
    if not ParasiteZed.qmarker then
        ParasiteZed.qmarker = getWorldMarkers():addGridSquareMarker("ParasiteZedNest_Marker9", "ParasiteZedNest_Marker9", sq, 0.1, 1, 0.1, true, rad)
        local pl = getPlayer()
        local function gas()
            rad = rad + 0.5
            local x, y, z = round(zed:getX()), round(zed:getY()), zed:getZ() or 0
            ParasiteZed.qmarker:setPosAndSize(x, y, z, rad)
            local targ = zed:getTarget()
            if targ and ParasiteZed.isWithinRange(targ, zed, rad) then
                ParasiteZed.spitScreen(0.6, 0.6, 0.6, 0.85, 8)
                getSoundManager():PlayWorldSound("ParasiteZed_SpitHit", pl:getSquare(), 0, 5, 5, false)
                pl:setHaloNote("toxic gas", 150, 250, 150, 900)
                pl:getBodyDamage():setFoodSicknessLevel(pl:getBodyDamage():getFoodSicknessLevel() + 0.05)
                pl:getStats():setDrunkenness(pl:getStats():getDrunkenness() + 0.05)
     
            end
        end
        Events.OnTick.Add(gas)
        timer:Simple(3, function()
           
            if ParasiteZed.qmarker then
                ParasiteZed.qmarker:remove()
                ParasiteZed.qmarker = nil
            end
            Events.OnTick.Remove(gas)
        end)
    end
end

function ParasiteZed.markQueen()
    if not (getCore():getDebug() or isAdmin()) then return end
    local queen = ParasiteZed.getNearestQueenToMidpoint(x, y)
    if queen then
        queen:addLineChatElement('Queen: '..tostring(queen:getOnlineID()))
        local sq = queen:getSquare()
        if sq then

            local pl = getPlayer()
            local x, y, z = round(pl:getX()),  round(pl:getY()), pl:getZ()

            ParasiteZed.queenArrow = getWorldMarkers():addPlayerHomingPoint(pl, queen:getX(), queen:getY(), "ParasiteZedNest_Guide", 0.8, 0.8, 0.8, 1, true, 20);

            timer:Simple(15, function()
                ParasiteZed.delQueenMark()
            end)
        end
    end
end

function ParasiteZed.delQueenMark()
    if not ParasiteZed.queenArrow then return end
    ParasiteZed.queenArrow:remove(); ParasiteZed.queenArrow = nil
end

function ParasiteZed.BugBombArmed(sq)
    local pl = getPlayer()
    sq = sq or pl:getSquare();
    if ParasiteZed.bomb ~= nil then
        ParasiteZed.delMark()
    end
    if sq then
        if ParasiteZed.bomb == nil then
            ParasiteZed.bomb = getWorldMarkers():addGridSquareMarker("ParasiteZedNest_BugBomb", "ParasiteZedNest_BugBomb",  sq, 1, 1, 1,  true,  5)
            --ParasiteZed.marker = getWorldMarkers():addPlayerHomingPoint(pl, sq:getX(), sq:getY(), "ParasiteZed", ParasiteZed.color.r, ParasiteZed.color.g, ParasiteZed.color.b, ParasiteZed.color.a, true, 60);
        end
    end
end


function ParasiteZed.showGuide()
    local sq = ParasiteZed.getNestCellData("sq")
    ParasiteZed.dirGuide(sq)
    local ticks = 0
    -----------------------
    function ParasiteZed.guideHandler()
        ticks = ticks + 1
        if not ParasiteZed.guide then
            Events.OnTick.Remove(guideHandler)
        end
        if ticks % 60 == 0 then
            ticks=0
            local dist = ParasiteZed.getNestCellData("dist")
            if dist <= ParasiteZed.MinDist then
                ParasiteZed.delGuide()
                Events.OnTick.Remove(ParasiteZed.guideHandler)
            end
        end
    end
    Events.OnTick.Add(ParasiteZed.guideHandler)
end


function ParasiteZed.dirGuide(sq)
    local pl = getPlayer()
    sq = sq or pl:getSquare();
    if ParasiteZed.guide ~= nil then
        ParasiteZed.delGuide()
    end
    if sq then
        if ParasiteZed.guide == nil then
            ParasiteZed.guide = getWorldMarkers():addPlayerHomingPoint(pl, sq:getX(), sq:getY(), "ParasiteZedNest_Guide", ParasiteZed.color.r, ParasiteZed.color.g, ParasiteZed.color.b, ParasiteZed.color.a, true, 60);
        end
    end
end

function ParasiteZed.delBomb()
    if ParasiteZed.bomb  ~= nil then
        ParasiteZed.bomb:remove()
        ParasiteZed.bomb = nil
    end
end
function ParasiteZed.delMark()
    if ParasiteZed.marker  ~= nil then
        ParasiteZed.marker:remove()
        ParasiteZed.marker = nil
    end
end
--ParasiteZed.addMark(getPointer())
function ParasiteZed.delGuide()
    if ParasiteZed.guide  ~= nil then
        ParasiteZed.guide:remove()
        ParasiteZed.guide = nil
    end
end
function ParasiteZed.clearMarkers()
    ParasiteZed.delGuide()
    ParasiteZed.delMark()
    ParasiteZed.delEgg()
    ParasiteZed.delQueenMark()
end
-----------------------            ---------------------------

function ParasiteZed.delayRemoveHL(pl, obj, sq)
    function ParasiteZed.doDelayRemoveHL()
        if ParasiteZed.checkDist(pl, sq) then
            print("doDelayRemoveHL")
            ParasiteZed.setHL(obj, false)
            Events.OnTick.Remove(ParasiteZed.doDelayRemoveHL)
        end
    end
    Events.OnTick.Add(ParasiteZed.doDelayRemoveHL)
end

function ParasiteZed.setHL(obj, bool)
    local pl = getPlayer()
    if not obj then return end
    local col = ParasiteZed.col
    obj:setHighlightColor(col);
    obj:setOutlineHighlightCol(col);
    local sq = obj:getSquare()
    if bool then
        ParasiteZed.delayRemoveHL(pl, obj, sq)
    end
    obj:setOutlineThickness(0.6);

    obj:setBlink(bool);
    obj:setOutlineHlBlink(bool);
    obj:setOutlineHighlight(bool);
    obj:setHighlighted(bool);
end

-----------------------            ---------------------------

function ParasiteZed.getNestCellEdgeSquares(startX, startY)
    local edgeSquares = {}
    local size = ParasiteZed.NestCellSize
    local cellWidth = size
    local cellHeight = size

    for x = startX, startX + cellWidth - 1 do
        table.insert(edgeSquares, {x = x, y = startY})
        table.insert(edgeSquares, {x = x, y = startY + cellHeight - 1})
    end

    for y = startY + 1, startY + cellHeight - 2 do
        table.insert(edgeSquares, {x = startX, y = y})
        table.insert(edgeSquares, {x = startX + cellWidth - 1, y = y})
    end

    return edgeSquares
end
function ParasiteZed.setMarkersToNestCellEdge(enable)
    local pl = getPlayer()
    local size = ParasiteZed.NestCellSize

    local x, y, z = round(pl:getX()), round(pl:getY()), 0
    local startX, startY = math.floor(x / size) * size, math.floor(y / size) * size
    ParasiteZed.edgeMarkers = ParasiteZed.edgeMarkers or {}

    if not enable then
        for _, marker in ipairs(ParasiteZed.edgeMarkers) do
            if marker then
                marker:remove()
            end
        end
        ParasiteZed.edgeMarkers = {}
        return
    end

    local edgeSquares = ParasiteZed.getNestCellEdgeSquares(startX, startY)
    for _, eSq in ipairs(edgeSquares) do
        local sq = getCell():getOrCreateGridSquare(eSq.x, eSq.y, z)
        if sq then
            local marker = getWorldMarkers():addGridSquareMarker("circle_center", "circle_only_highlight", sq, 1, 1, 1, true, 1)
            table.insert(ParasiteZed.edgeMarkers, marker)
        end
    end
end
--[[
ParasiteZed.setMarkersToNestCellEdge(true)
ParasiteZed.setMarkersToNestCellEdge(false)
 ]]