

--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

ParasiteZed = ParasiteZed or {}



-----------------------     context*          ---------------------------

--[[
	local toRemove = inv:FindAndReturn("Base.ParasiteZed")
	if toRemove then
		ISRemoveItemTool.removeItem(toRemove, plNum)
	end


 ]]

function ParasiteZed.invContext(plNum, context, items)

	local pl = getSpecificPlayer(plNum)
	local inv = pl:getInventory()


	local bombItem = nil
	local item = nil
	local fType =  "Base.ParasiteZed_BugBomb"

	local bombItem = nil
	for i, check in ipairs(items) do
		if type(check) == "table" then
			item = check.items[1]

		elseif instanceof(check, "InventoryItem") then
			item = check
		end
		if item and item:getFullType() == fType then
			bombItem = item
			break
		end
	end


	if bombItem then
		local optTip = context:addOptionOnTop(getText("ContextMenu_ParasiteZed_Bomb"), nil, function()
			ParasiteZed.place(nil, bombItem)
		end)
        optTip.iconTexture = getTexture("media/textures/Item_ParasiteZed_BugBomb.png")
	end

end
Events.OnFillInventoryObjectContextMenu.Remove(ParasiteZed.invContext);
Events.OnFillInventoryObjectContextMenu.Add(ParasiteZed.invContext);


-----------------------            ---------------------------
function ParasiteZed.isAdm(pl)
    pl = pl or getPlayer()
    if not pl then return false end
    return isClient() and string.lower(pl:getAccessLevel()) == "admin"
end

function ParasiteZed.Context(player, context, worldobjects)
	local pl = getSpecificPlayer(player)
	local sq = clickedSquare
	if not  ParasiteZed.isAdm(pl) then return end
	local title = ""
	local x, y = round(pl:getX()), round(pl:getY())
	if not sq or not x or not y then return end

	if  getCore():getDebug() or	sq:DistTo(x, y) <= 3 or sq == pl:getCurrentSquare() then

		local mainOpt = context:addOptionOnTop(getText("ContextMenu_ParasiteZed_Debug"))
		mainOpt.iconTexture = getTexture("media/ui/ParasiteZed_Context.png")
		local rootMenu = ISContextMenu:getNew(context)
		context:addSubMenu(mainOpt, rootMenu)




		local clearOpt = rootMenu:addOption(getText("ContextMenu_ParasiteZed_Clear"), worldobjects, function()
			pl:getModData().ParasiteInfectionTime = nil
		end)
		local clearTip = ISWorldObjectContextMenu.addToolTip()
		if ParasiteZed.isParasiteInfected(pl) then
			local remaining = pl:getModData().ParasiteInfectionTime or 0
			clearTip.description = getText("ContextMenu_ParasiteZed_TimeLeft") .. ": " .. tostring(remaining)
		else
			clearTip.description = "Not Infected"
			clearOpt.notAvailable = true
		end
		clearOpt.toolTip = clearTip

		local skinMenu = ISContextMenu:getNew(context)
		rootMenu:addSubMenu(rootMenu:addOption(getText("ContextMenu_ParasiteZed_Skin")), skinMenu)

		skinMenu:addOption(getText("ContextMenu_ParasiteZed_WearSkin"), worldobjects, function()
			ParasiteZed.wearParasiteZed(pl)
			local md = pl:getModData()
			md.isParasitePl = true
			md.isParasiteQueenPl = false
		end)

		skinMenu:addOption(getText("ContextMenu_ParasiteZed_WearQueenSkin"), worldobjects, function()
			ParasiteZed.wearParasiteZed_Queen(pl)
			local md = pl:getModData()
			md.isParasitePl = false
			md.isParasiteQueenPl = true
		end)

		skinMenu:addOption(getText("ContextMenu_ParasiteZed_RemoveSkin"), worldobjects, function()
			ParasiteZed.clearParasiteZedSkin(pl)
		end)

		-----------------------            ---------------------------

--[[ 
		local function spawnZeds(count, type)
			for i = 1, count do
				ParasiteZed.doSpawn(sq, false, type)
			end
		end
		 ]]

		
		rootMenu:addOption(getText("ContextMenu_ParasiteZed_Spawn"), worldobjects, function()
			ParasiteZed.doSpawnQueen(sq, true, "ParasiteZed_Queen")
		end)


		-----------------------            ---------------------------



		local emoteMenu = ISContextMenu:getNew(context)
		rootMenu:addSubMenu(rootMenu:addOption(getText("ContextMenu_ParasiteZed_Emote")), emoteMenu)

		local emotes = {
			"Insect_Flop", "Insect_Snap", "Insect_Hurt", "Insect_Hurt2",
			"Insect_Hurt3", "Insect_Climb", "Insect_Roll", "Insect_Thump",
			"Insect_FloorFront", "Insect_FloorBack"
		}

		for _, emote in ipairs(emotes) do
			emoteMenu:addOption(emote, worldobjects, function()
				pl:playEmote(emote)
			end)
		end

		local function killZombiesInRadius(centerPl, radius, predicate)
			local killed = 0
			local cell = centerPl:getCell()
			local x, y, z = centerPl:getX(), centerPl:getY(), centerPl:getZ()
			for dx = -radius, radius do
				for dy = -radius, radius do
					local sq = cell:getGridSquare(x + dx, y + dy, z)
					if sq then
						local zed = sq:getZombie()
						if zed and predicate(zed) then
							killed = killed + 1
							zed:changeState(ZombieOnGroundState.instance())
							zed:setAttackedBy(cell:getFakeZombieForHit())
							zed:becomeCorpse()
						end
					end
				end
			end
			return killed
		end

		local killMenu = ISContextMenu:getNew(context)
		rootMenu:addSubMenu(rootMenu:addOption(getText("ContextMenu_ParasiteZed_Despawn")), killMenu)

		killMenu:addOption(getText("ContextMenu_ParasiteZed_KillParasite"), worldobjects, function()
			local count = killZombiesInRadius(pl, 15, ParasiteZed.isParasiteZed)
			print("Killed " .. count .. (count == 1 and " Parasite" or " Parasites"))
		end)

		killMenu:addOption(getText("ContextMenu_ParasiteZed_KillQueen"), worldobjects, function()
			local count = killZombiesInRadius(pl, 15, ParasiteZed.isParasiteQueen)
			print("Killed " .. count .. (count == 1 and " Queen" or " Queens"))
		end)

		killMenu:addOption(getText("ContextMenu_ParasiteZed_KillOther"), worldobjects, function()
			killZombiesInRadius(pl, 15, function(zed) return not (ParasiteZed.isParasiteZed(zed) and ParasiteZed.isParasiteQueen(zed)) end)
		end)

		local wipOpt = rootMenu:addOptionOnTop(getText("ContextMenu_ParasiteZed_DebugPrints")..": "..tostring(ParasiteZed.isWIP), worldobjects, function()
			ParasiteZed.isWIP = not ParasiteZed.isWIP
		end)
		local tip = ISWorldObjectContextMenu.addToolTip()

		rootMenu:setOptionChecked(wipOpt,  ParasiteZed.isWIP)
--[[ 

		local tip = ISWorldObjectContextMenu.addToolTip()
		tip.description = "Distance: "..tostring(math.floor(ParasiteZed.getNestCellData("dist")))
		tpOpt.toolTip = tip ]]
	end
end

Events.OnFillWorldObjectContextMenu.Remove(ParasiteZed.Context)
Events.OnFillWorldObjectContextMenu.Add(ParasiteZed.Context)

--[[
-----------------------  dbg*         ---------------------------

getPlayer():setVariable('isParasitePl', not getPlayer():getVariableBoolean('isParasitePl'))

 ]]


