--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


ParasiteZed = ParasiteZed or {}
local Commands = {};
Commands.ParasiteZed = {};

-----------------------            ---------------------------
function ParasiteZed.wearFit(pl, fType)
	pl = pl or getPlayer()
    ParasiteZed.clearParasiteZedSkin(pl)
	local item = InventoryItemFactory.CreateItem(fType)
	local inv = pl:getInventory()
	local equip = inv:addItem(item);
	pl:setWornItem(equip:getBodyLocation(), equip);
	if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
	triggerEvent("OnClothingUpdated", pl)
	pl:resetModelNextFrame();

	ParasiteZed.plSync()
end

function ParasiteZed.wearParasiteZed(pl)
	pl = pl or getPlayer()
	local fType = 'Base.ParasiteZed'
	ParasiteZed.wearFit(pl, fType)
    pl:getModData()['isParasitePl'] = true
    pl:getModData()['isParasiteQueenPl'] = false
end

function ParasiteZed.wearParasiteZed_Queen(pl)
	pl = pl or getPlayer()
	local fType = 'Base.ParasiteZed_Queen'
	ParasiteZed.wearFit(pl, fType)
    pl:getModData()['isParasiteQueenPl'] = true
    pl:getModData()['isParasitePl'] = false
end


-----------------------       ---------------------------


function ParasiteZed.clearParasiteZedSkin(pl)
	pl = pl or getPlayer()

	local inv = pl:getInventory()
	for i = inv:getItems():size(), 1, -1 do
		local item = inv:getItems():get(i-1)
		if item then
			if item:getFullType() == "Base.ParasiteZed" or item:getFullType() == "Base.ParasiteZed_Queen"  then
				inv:DoRemoveItem(item)
				pl:removeWornItem(item)
				inv:Remove(item)
			end
		end
	end
	pl:setHideWeaponModel(false)
	pl:clearWornItems();
	pl:resetModelNextFrame();
	pl:getModData()['isParasitePl'] = false
	pl:getModData()['isParasiteQueenPl'] = false
	triggerEvent("OnClothingUpdated", pl)
	ParasiteZed.plSync()
end
-----------------------            ---------------------------

function ParasiteZed.wpnHide(pl, wpn)
    local mods = getActivatedMods()
    if mods:contains("BanditsLegacy") or mods:contains("Bandits2") or mods:contains("BanditsDayOne") then
        Events.OnEquipPrimary.Remove(ParasiteZed.wpnHide)
        Events.OnEquipSecondary.Remove(ParasiteZed.wpnHide)
        return
    end
    
    local isParasite = ParasiteZed.isParasitePl(pl) or ParasiteZed.isParasiteQueenPl(pl)
    pl:setHideWeaponModel(isParasite)
    pl:setIgnoreAutoVault(isParasite)

    JoypadState.disableGrab = isParasite
    JoypadState.disableYInventory = isParasite
    JoypadState.disableClimbOver = isParasite
    JoypadState.disableSmashWindow = isParasite
    JoypadState.disableReload = isParasite

    ISBackButtonWheel.disableCrafting = isParasite
    ISBackButtonWheel.disableMoveable = isParasite
	ParasiteZed.plSync()
end

Events.OnEquipPrimary.Add(ParasiteZed.wpnHide)
Events.OnEquipSecondary.Add(ParasiteZed.wpnHide)

-----------------------            ---------------------------

function ParasiteZed.isBiteReact(pl)
	local attacker = nil
	if pl:getVariableString("HitReaction") == "Bite" then
		attacker = pl:getVariableString("getLastTargettedBy")
		return true
	end
	return false
end

-----------------------            ---------------------------
function ParasiteZed.isUnarmed(pl)
	return tostring(WeaponType.getWeaponType(pl)) == 'barehand'
end

-----------------------            ---------------------------
--[[ 
function ParasiteZed.plSync(pl)
    local modData = pl:getModData()
    if modData.isParasitePl == nil then
        modData.isParasitePl = ParasiteZed.isParasitePl(pl)
    end

    local currentIsParasite = ParasiteZed.isParasitePl(pl)
    local currentIsQueen = ParasiteZed.isParasiteQueenPl(pl)

    local isParasitePl = pl:getVariableBoolean("isParasitePl")
    local isParasiteQueenPl = pl:getVariableBoolean("isParasiteQueenPl")

    if currentIsParasite and not isParasitePl then
        pl:setVariable("isParasitePl", true)
        pl:setVariable("isParasiteQueenPl", false)
        if isClient() then
            sendClientCommand("ParasiteZed", "isParasitePl", {isParasitePl = true, plId = pl:getOnlineID()})
        end
    elseif not currentIsParasite and isParasitePl then
        pl:setVariable("isParasitePl", false)
        if isClient() then
            sendClientCommand("ParasiteZed", "isParasitePl", {isParasitePl = false, plId = pl:getOnlineID()})
        end
    end

    if currentIsQueen and not isParasiteQueenPl then
        pl:setVariable("isParasiteQueenPl", true)
        pl:setVariable("isParasitePl", false)
        if isClient() then
            sendClientCommand("ParasiteZed", "isParasiteQueenPl", {isParasiteQueenPl = true, plId = pl:getOnlineID()})
        end
    elseif not currentIsQueen and isParasiteQueenPl then
        pl:setVariable("isParasiteQueenPl", false)
        if isClient() then
            sendClientCommand("ParasiteZed", "isParasiteQueenPl", {isParasiteQueenPl = false, plId = pl:getOnlineID()})
        end
    end
end
Events.OnPlayerUpdate.Remove(ParasiteZed.plSync)

Events.OnPlayerUpdate.Add(ParasiteZed.plSync)
 ]]
--[[ 
Events.OnLoad.Add(ParasiteZed.plSync)
Events.OnClothingUpdated.Add(ParasiteZed.plSync)

Events.OnScoreboardUpdate.Add(ParasiteZed.plSync)


 ]]
