--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
ParasiteZed = ParasiteZed or {}

LuaEventManager.AddEvent("BugBombExploded")


require "TimedActions/ISBaseTimedAction"
require "TimedActions/ISBaseTimedAction"
require "lua_timers"

ParasiteZed = ParasiteZed or {}
LuaEventManager.AddEvent("BugBombExploded")

BugBombAction = ISBaseTimedAction:derive("BugBombAction")

function BugBombAction:isValid()
    return self.character:getInventory():contains(self.item) and self.sq ~= nil and self.nest ~= nil
end

function BugBombAction:waitToStart()
    self.character:faceLocation(self.sq:getX(), self.sq:getY())
    return self.character:shouldBeTurning()
end

function BugBombAction:update()

end

function BugBombAction:start()

    self.character:setActionAnim("Loot")
    self.character:SetVariable("LootPosition", "Low")
    self.character:reportEvent("EventLootItem")
end

function BugBombAction:stop()
    ISBaseTimedAction.stop(self)
    if self.item then
        self.item:setJobDelta(0.0)
    end
end

function ParasiteZed.doSledge(obj)
    if obj then
        local sq = obj:getSquare()
        if isClient() then
            sledgeDestroy(obj)
        else
            if sq then
                sq:RemoveTileObject(obj);
                sq:getSpecialObjects():remove(obj);
                sq:getObjects():remove(obj);
            end
        end
        if sq then
            sq:transmitRemoveItemFromSquare(obj)
        end
    end
end
function BugBombAction:perform()
    local x, y, z = self.sq:getX(), self.sq:getY(), self.sq:getZ()
    local args = { x = x, y = y, z = z }

    sendClientCommand(self.character, 'object', 'addSmokeOnSquare', args)
    getSoundManager():PlayWorldSound('ParasiteZed_BugBomb', self.sq, 0, 35, 1, false)
    addSound(self.character, x, y, z, 35, 1, true)

    ISRemoveItemTool.removeItem(self.item, self.character:getPlayerNum())




    ParasiteZed.delayTrigger(self.sq, 5, true, function()
        ParasiteZed.delMark()
        getSoundManager():PlayWorldSound('AerosolBombExplode', self.sq, 0, 5, 1, false)
        addSound(self.character, x, y, z, 5, 1, true)
        sendClientCommand(self.character, 'object', 'addExplosionOnSquare', args)

    end)



    ParasiteZed.delayTrigger(self.sq, 10, false, function()
        ParasiteZed.doRemoveDebris(self.sq)
    end)




        --triggerEvent("BugBombExploded", self.sq)

        --ParasiteZed.doSledge(self.nest)


    ISBaseTimedAction.perform(self)
end

function BugBombAction:new(character, sq, nest, item)
    local o = ISBaseTimedAction.new(self, character)
    o.character = character
    o.sq = sq
    o.nest = nest
    o.item = item
    o.stopOnWalk = true
    o.stopOnRun = true
    o.maxTime = 100
    if character:isTimedActionInstant() then o.maxTime = 1 end
    return o
end

function ParasiteZed.delayTrigger(sq, targetSec, isShouldCount, func)
    if not sq or not func then return end

    local pl = getPlayer()
    local startTimestamp = getTimestampMs()

    local secDelay
    secDelay = function()
        local currentTimestamp = getTimestampMs()
        local elapsedTimeSec = math.floor((currentTimestamp - startTimestamp) / 1000)

        if elapsedTimeSec <= targetSec then
            if isShouldCount and getCore():getDebug() then
                pl:setHaloNote("t+" .. elapsedTimeSec, 150, 250, 150, 60)
            end
        else
            Events.OnTick.Remove(secDelay)
            func()
        end
    end

    Events.OnTick.Add(secDelay)
end
--[[
    ParasiteZed.delayTrigger(self.sq, 10, false, function()
        ParasiteZed.doRemoveDebris(self.sq)
    end)

 ]]
--[[
BugBombAction = ISBaseTimedAction:derive("BugBombAction")

function BugBombAction:isValid()
    return self.nest and self.item
end

function BugBombAction:waitToStart()
	self.character:faceLocation(self.sq:getX(), self.sq:getY())
	return self.character:shouldBeTurning()
end

function BugBombAction:update()
	self.character:faceLocation(self.sq:getX(), self.sq:getY())
    if self.item then
	    self.item:setJobDelta(self:getJobDelta());
    end
    local adj = self.character:getSquare():getAdjacentSquare(self.character:getDir());

    if self.sq == adj or self.sq == self.character:getCurrentSquare()  then
        self:perform()
    end
end


function BugBombAction:start()
    self.character:setActionAnim("Loot")
    self.character:SetVariable("LootPosition", "Low")
    self.character:reportEvent("EventLootItem");
end

function BugBombAction:stop()
    ISBaseTimedAction.stop(self)
end

function BugBombAction:perform()
    if not self.sq then return end

    local x, y, z = round(self.sq:getX()), round(self.sq:getY()), self.sq:getZ()
    local args = { x = x, y = y, z = z }

    sendClientCommand(self.character, 'object', 'addSmokeOnSquare', args)
    getSoundManager():PlayWorldSound('ParasiteZed_BugBomb', self.sq, 0, 35, 1, false)
    addSound(self.character, x, y, z, 35, 1, true)

    ISRemoveItemTool.removeItem(self.item, self.character:getPlayerNum())
   -- ParasiteZed.BugBombArmed(self.sq)

    timer:Simple(10, function()
        getSoundManager():PlayWorldSound('AerosolBombExplode', self.sq, 0, 5, 1, false)
        addSound(self.character, x, y, z, 5, 1, true)
        sendClientCommand(self.character, 'object', 'addExplosionOnSquare', args)
        triggerEvent("BugBombExploded", self.sq)

        ParasiteZed.delMark()
        ParasiteZed.doSledge(self.nest)
    end)

    ISBaseTimedAction.perform(self)
end

function BugBombAction:new(character, sq, nest, item)
    local o = ISBaseTimedAction.new(self, character)
    ParasiteZed.nest = nest
    o.character = character
    o.sq = sq
    o.nest = nest
    o.item = item
    o.maxTime = 60
    return o
end
 ]]

--ParasiteZed.getSprName(obj)
--ParasiteZed.isSpawnerNest(sprName)

ParasiteZed.debris = {
    ['preset_depthmaps_01_7']=true,
    ['ParasiteZedNest_0']=true,
    ['ParasiteZedNest_5']=true,
    ['ParasiteZedNest_4']=true,
    ['ParasiteZedNest_3']=true,
    ['ParasiteZedNest_2']=true,
    ['ParasiteZedNest_1']=true,
}

function ParasiteZed.removeDebris(sq, targSec, func)
    local tick = Calendar.SECOND
    local tock = 0
    local pl = getPlayer()
    local function delay()
        local sec = Calendar.SECOND
        if tick ~= sec then
            tock = tock + 1
            if tock >= targSec then
                func()
                Events.OnTick.Remove(delay);
            end
            tick = sec
            if getCore():getDebug() then
                pl:setHaloNote(tostring(tock),150,250,150,60)
            end
        end
	end
    Events.OnTick.Add(delay);
end
--ParasiteZed.removeDebris(sq, 3, function() ParasiteZed.doRemoveDebris(sq) end)

function ParasiteZed.doRemoveDebris(sq)
    if not sq then return end

    local radius = 16
    local plNum = getPlayer():getPlayerNum() or 0
    local cell = getCell()
    local x, y, z = sq:getX(), sq:getY(), sq:getZ()

    for dx = -radius, radius do
        for dy = -radius, radius do
            local sq2 = cell:getOrCreateGridSquare(x + dx, y + dy, z)

            local objects = sq2:getObjects()
            for i = 0, objects:size() - 1 do
                local obj = objects:get(i)
                local sprName = ParasiteZed.getSprName(obj)
                if sprName and ParasiteZed.debris[sprName] then
                    ParasiteZed.doSledge(obj)
                end
                if ParasiteZed.nest == obj then
                    ParasiteZed.reVar(obj)
                end
            end

            local movers = sq2:getMovingObjects()
            for i = 0, movers:size() - 1 do
                local chr = movers:get(i)
                if instanceof(chr, "IsoGameCharacter") and chr:isOnFire() then
                    if isClient() then
                        chr:sendStopBurning()
                    else
                        chr:StopBurning()
                    end
                end
            end

            local worldItems = sq2:getWorldObjects()
            for i = 0, worldItems:size() - 1 do
                local item = worldItems:get(i):getItem()
                if item and item:getFullType() == "Base.ParasiteZed_BugBomb" then
                    ISRemoveItemTool.removeItem(item, plNum)
                end
            end

            if sq2:Is(IsoFlagType.burning) then
                sq2:stopFire()
                sq2:transmitStopFire()
            end
        end
    end
    ParasiteZed.nest=nil
end



function ParasiteZed.BugBombContext(player, context, worldobjects, test)
	local pl = getSpecificPlayer(player)
	local sq = clickedSquare
	if not sq then return end
    local inv = pl:getInventory()
    local bombItem = inv:FindAndReturn("Base.ParasiteZed_BugBomb")
    local nest = nil
    local sprName = nil
	for i=0, sq:getObjects():size()-1 do
		local obj = sq:getObjects():get(i)
        sprName = ParasiteZed.getSprName(obj)
        if sprName and ParasiteZed.isSpawnerNest(sprName) then
            nest = obj
            break
        end
	end

	if not sprName then return end

    if nest then
        local optTip = context:addOptionOnTop("Arm Bug Bomb", worldobjects, function()
            if luautils.walkAdj(pl, sq) then

                ISTimedActionQueue.add(BugBombAction:new(pl, sq, nest, item))
            end
            getSoundManager():playUISound("UIActivateMainMenuItem")
            context:hideAndChildren()
        end)
        if not bombItem then
            optTip.notAvailable = true
        end
        local iconPath = "textures/Item_ParasiteZed_BugBomb.png"
        optTip.iconTexture = getTexture(iconPath)

    end
end
Events.OnFillWorldObjectContextMenu.Remove(ParasiteZed.BugBombContext)
Events.OnFillWorldObjectContextMenu.Add(ParasiteZed.BugBombContext)

function ParasiteZed.exploded(sq)
    local pl = getPlayer()
	local x, y = sq:getX(), sq:getY()
	local dist = pl:DistTo(x, y)
    print("BugBomb Exploded " .. tostring(dist) .. " squares away")

end
--Events.BugBombExploded.Add(ParasiteZed.exploded)



-----------------------            ---------------------------
--[[
    local x, y, z = round(self.sq:getX()),  round(self.sq:getY()),  self.sq:getZ() or 0

    local args = { x = x, y = y, z = z }
    sendClientCommand(self.character, 'object', 'addSmokeOnSquare', args)

    getSoundManager():PlayWorldSound('ParasiteZed_BugBomb', self.sq, 0, 35, 1, false);
    addSound(self.character, round(self.sq:getX()),  round(self.sq:getY()),  self.sq:getZ(), 35, 1, true)

    ISRemoveItemTool.removeItem(self.item, self.character:getPlayerNum())
    ParasiteZed.BugBombArmed(self.sq)
 ]]
    --[[
    timer:Simple(10, function()
        getSoundManager():PlayWorldSound('AerosolBombExplode', self.sq, 0, 5, 1, false);
        addSound(self.character, round(self.sq:getX()),  round(self.sq:getY()),  self.sq:getZ(), 5, 1, true)
        sendClientCommand(self.character, 'object', 'addExplosionOnSquare', args)
        triggerEvent("BugBombExploded", self.sq)
        ParasiteZed.delMark()
        if self.nest then
            if isClient() then
                sledgeDestroy(self.nest)
            else
                if self.sq then
                    self.sq:RemoveTileObject(self.nest);
                    self.sq:getSpecialObjects():remove(self.nest);
                    self.sq:getObjects():remove(self.nest);
                    self.sq:transmitRemoveItemFromSquare(self.nest)
                end
            end
        end
    end)
 ]]



